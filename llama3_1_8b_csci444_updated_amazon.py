# -*- coding: utf-8 -*-
"""llama3.1-8B_CSCI444_updated_amazon.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1DpA6kXnUCBK_nWH34JgJ8chyfXKxIsUB

Setting up
"""

import openai
import os
import pandas as pd
import json
import requests

api_key = os.environ.get("LEPTON_API_TOKEN", "gnULUWYeR9hzy2uygiXoqvi1gkoPuVKD")
base_url = "https://llama3-1-8b.lepton.run/api/v1/"
headers = {
    "Authorization": f"Bearer {api_key}",
    "Content-Type": "application/json",
}

"""Function for generating initial summary"""

def initialSumm(df, model, max_tokens):

    df["summary1"] = [""] * len(df) #when creting a new column, the value you assign must have the same length as the df's index OR use another way to create new column

    for i in range(len(df)):
        print(f"Processing initial summary for row {i + 1}/{len(df)}")
        # Create the prompt
        prompt =  """Below is an instruction that describes a task.
### Instruction: You are given a set of reviews separated by ||. All reviews are in the format {rating: NUMBER} “{REVIEW_TEXT}“, including rating information of a product given by the review writer. Please write a short text containing the salient information, i.e. a summary.

Reviews:
|| : {rating: 3} “I know that the point of these bags is for them to be for small snack items , but they were too small for most of what I wanted to use them for . I think the normal sandwich sized bags work just as well .”
||: {rating: 5} “ I used these for travel sized items being I hate spillage in my suitcase . I store small items such as loose herbs in them for immediate use. “
||: {rating: 5} “ I love the little Snack bags and I can no longer find them in our stores . They are just the right size for taking small snacks in the car . “
||: {rating: 5} “Using them so sort meds on a mission clinic , but you can put chips , pretzels , pens , paper clips , hole punch holes , half a squished sandwich , or just about anything that will fit . The possibilities are endless . “
||: {rating: 5} “ Great little snack bags for treats or healthy snacks alike . They are strong , quality made bags that hold just enough . Good sealing as there is nothing worse than spilled / lost snacks , when you are counting each and every one to make up that 100 calories , LOL ! “
||: {rating: 5} “ These small bags are great for snacks . I use them for homemade trail mix or celery and carrot sticks and carry a couple of bags with me so I always have a healthy snack available . Otherwise it 's easy and tempting to grab something unhealthy when an attack of the munchies comes along . “
||: {rating: 5} “ THESE BAGS ARE THE BES , WE USE THEN IN EVERY WAY POSSIBLE AT HOME AND WHEN THE KIDS HAVE TO GO TO SCHOOL . “
||: {rating: 5} “ I love snack size bags and am happy to find them on Amazon . These bags are perfect for packing snacks on the go without using bigger sandwich bags . I also use these smaller bags to organize office and hair supplies . “
||: {rating: 5} “I got 6 total boxes . I love the ziploc ones because of the double seal . The bags are reusable for about 5 times before they get nasty .”

Summary: The reviews highlight the high satisfaction with these small snack bags, primarily praised for their versatility, durability, and suitability for various uses such as storing snacks, organizing small items, and traveling. Users appreciate their compact size, strong seal, and reusability. While most reviews are highly positive (ratings of 5), one user (rating of 3) found the bags too small for their needs, suggesting that standard sandwich bags might suffice in some cases. Overall, the bags are valued for their convenience, quality, and functionality.


Below is an instruction that describes a task.
### Instruction: You are given a set of reviews separated by ||. All reviews are in the format {rating: NUMBER} “{REVIEW_TEXT}“, including rating information of a product given by the review writer. Please write a short text containing the salient information, i.e. a summary.

Reviews:
||: {rating: 1} “ Over priced . Low mg dose . Do not ever , under any circumstance , let yourself succumb to the temptation to purchase these softgels . “
||: {rating: 5} “ Ubiquinol is the preferred method to take coQ10. ubiquinone is cheaper but not nearly as effective . Would clearly recommend this product over ubiquinone . “
|| : {rating: 5} “I Bought this product to compare with other brands that I purchased before . Although these are a little bit bigger than other brands it is still easy to swallow . I think the quality is very good and will order from this company again . “
|| : {rating: 5} “This is a good product at a good price . I like NutriGold products because they are are careful about the type of gel caps they use , and they don 't add anything extra . Ubiquinol is a patented product , so the only real difference is products is in the capsules . “
|| : {rating: 4} “Decent brand - No adverse effects ( headaches and queasiness ) as experienced with some other brands of ubiquinol.Would buy again . “
|| : {rating: 5} “I am happy with the product . I take one capsule a day and have been satisfied . Thanks for selling a good quality product . “
|| : {rating: 4} “Cholesterol meds deplete COQ10 and of course my heart muscle is of great concern . Ubiquinol Gold by NutriGold is not only more bio-available . But it 's also quickly available as shipping has always been very prompt with my orders . : ) “
||: {rating: 4} “ I regularly take CoQ10 because I have poor circulation and CoQ10 helps with heart issues . I noticed that when I take Ubiquinol , I don 't need to take the Flaxseed and Cayenne Pepper because my limbs stay warm . Great product and great company . Also , I like th packaging the product comes in . Not the bottle but the mailing package. “
||: {rating: 5} “ From What I 've investigated about this product , it is certainly the best for the price.Haven 't used it long enough to see an improvement yet but I 'm going to keep trying ! !”

Summary:  The reviews for the Ubiquinol product are overwhelmingly positive, with users praising its quality, effectiveness, and bioavailability, particularly for heart health and circulation issues. Many appreciate the product’s easy-to-swallow capsules, lack of unnecessary additives, and good value for the price. NutriGold’s careful formulation and prompt shipping also receive commendation. A few users highlight specific benefits, such as replacing other supplements or avoiding adverse effects experienced with other brands. However, one reviewer (rating of 1) criticized the product as overpriced with a low dosage, strongly advising against purchase. Overall, the product is well-regarded for its quality and effectiveness.

Below is an instruction that describes a task.
### Instruction: You are given a set of reviews separated by ||. All reviews are in the format {rating: NUMBER} “{REVIEW_TEXT}“, including rating information of a product given by the review writer. Please write a short text containing the salient information, i.e. a summary.

Reviews: """ + df['reviews'][i] + """\n\nsummary:"""

        payload = {
            "model": model,
            "prompt": prompt,
            "max_tokens": max_tokens,
        }

        # Make the request
        response = requests.post(f"{base_url}/completions", headers=headers, json=payload)

        # Handle the response
        if response.status_code == 200:
            response_data = response.json()
            summary = response_data.get("choices", [{}])[0].get("text", "").strip()
            df.loc[i, "summary1"] = summary  # Use df.loc for safe assignment
        else:
            print(f"Error for row {i}: {response.status_code}, {response.text}")
            df.loc[i, "summary1"] = None

    return df

"""Function for generating feedback"""

def generateFeedback(df, summary_col, feedback_col, model, max_tokens):

    df[feedback_col] = [""] * len(df)

    for i in range(len(df)):
        print(f"Processing feedback for row {i + 1}/{len(df)} on column {summary_col}")
        # Create the prompt
        prompt =  """You are an annotator for the fairness of summarization. You are given a set of reviews separated by I I. All reviews are in the format {rating: NUMBER} “{REVIEW_TEXT}“, including rating information of a product given by the review writer. Your task is to provide feedback on how fairness can be improved. A summary is considered unfair if it doesn’t properly represent reviews with different attributes (such as rating). Therefore, the proportion of attributes reflected in the target summary should match the proportion in the reviews.

Reviews: || : {rating: 3} “I know that the point of these bags is for them to be for small snack items , but they were too small for most of what I wanted to use them for . I think the normal sandwich sized bags work just as well .”
||: {rating: 5} “ I used these for travel sized items being I hate spillage in my suitcase . I store small items such as loose herbs in them for immediate use. “
||: {rating: 5} “ I love the little Snack bags and I can no longer find them in our stores . They are just the right size for taking small snacks in the car . “
||: {rating: 5} “Using them so sort meds on a mission clinic , but you can put chips , pretzels , pens , paper clips , hole punch holes , half a squished sandwich , or just about anything that will fit . The possibilities are endless . “
||: {rating: 5} “ Great little snack bags for treats or healthy snacks alike . They are strong , quality made bags that hold just enough . Good sealing as there is nothing worse than spilled / lost snacks , when you are counting each and every one to make up that 100 calories , LOL ! “
||: {rating: 5} “ These small bags are great for snacks . I use them for homemade trail mix or celery and carrot sticks and carry a couple of bags with me so I always have a healthy snack available . Otherwise it 's easy and tempting to grab something unhealthy when an attack of the munchies comes along . “
||: {rating: 5} “ THESE BAGS ARE THE BES , WE USE THEN IN EVERY WAY POSSIBLE AT HOME AND WHEN THE KIDS HAVE TO GO TO SCHOOL . “
||: {rating: 5} “ I love snack size bags and am happy to find them on Amazon . These bags are perfect for packing snacks on the go without using bigger sandwich bags . I also use these smaller bags to organize office and hair supplies . “
||: {rating: 5} “I got 6 total boxes . I love the ziploc ones because of the double seal . The bags are reusable for about 5 times before they get nasty .”

Summary: The reviews highlight the high satisfaction with these small snack bags, primarily praised for their versatility, durability, and suitability for various uses such as storing snacks, organizing small items, and traveling. Users appreciate their compact size, strong seal, and reusability. While most reviews are highly positive (ratings of 5), one user (rating of 3) found the bags too small for their needs, suggesting that standard sandwich bags might suffice in some cases. Overall, the bags are valued for their convenience, quality, and functionality.

Feedback: The summary is mostly fair but could improve in reflecting the proportion of ratings accurately. Out of the nine reviews provided, eight (approximately 89%) are rated 5, and one (approximately 11%) is rated 3. The summary effectively emphasizes the positive attributes of the product, which aligns with the predominance of high ratings. However, the single 3-star review is mentioned briefly and might not proportionally reflect its less favorable sentiment relative to the dominant positivity.

Reviews: ||: {rating: 1} “ Over priced . Low mg dose . Do not ever , under any circumstance , let yourself succumb to the temptation to purchase these softgels . “
||: {rating: 5} “ Ubiquinol is the preferred method to take coQ10. ubiquinone is cheaper but not nearly as effective . Would clearly recommend this product over ubiquinone . “
|| : {rating: 5} “I Bought this product to compare with other brands that I purchased before . Although these are a little bit bigger than other brands it is still easy to swallow . I think the quality is very good and will order from this company again . “
|| : {rating: 5} “This is a good product at a good price . I like NutriGold products because they are are careful about the type of gel caps they use , and they don 't add anything extra . Ubiquinol is a patented product , so the only real difference is products is in the capsules . “
|| : {rating: 4} “Decent brand - No adverse effects ( headaches and queasiness ) as experienced with some other brands of ubiquinol.Would buy again . “
|| : {rating: 5} “I am happy with the product . I take one capsule a day and have been satisfied . Thanks for selling a good quality product . “
|| : {rating: 4} “Cholesterol meds deplete COQ10 and of course my heart muscle is of great concern . Ubiquinol Gold by NutriGold is not only more bio-available . But it 's also quickly available as shipping has always been very prompt with my orders . : ) “
||: {rating: 4} “ I regularly take CoQ10 because I have poor circulation and CoQ10 helps with heart issues . I noticed that when I take Ubiquinol , I don 't need to take the Flaxseed and Cayenne Pepper because my limbs stay warm . Great product and great company . Also , I like th packaging the product comes in . Not the bottle but the mailing package. “
||: {rating: 5} “ From What I 've investigated about this product , it is certainly the best for the price.Haven 't used it long enough to see an improvement yet but I 'm going to keep trying ! !”

Summary:  The reviews for the Ubiquinol product are overwhelmingly positive, with users praising its quality, effectiveness, and bioavailability, particularly for heart health and circulation issues. Many appreciate the product’s easy-to-swallow capsules, lack of unnecessary additives, and good value for the price. NutriGold’s careful formulation and prompt shipping also receive commendation. A few users highlight specific benefits, such as replacing other supplements or avoiding adverse effects experienced with other brands. However, one reviewer (rating of 1) criticized the product as overpriced with a low dosage, strongly advising against purchase. Overall, the product is well-regarded for its quality and effectiveness.

Feedback: The summary effectively captures the positive sentiment expressed by the majority of reviewers but could be more balanced by proportionally representing the 4-star reviews, which account for 33% of the feedback. While the 1-star review is mentioned, its critique could be slightly elaborated to reflect its strong dissatisfaction with price and dosage. Additionally, the nuanced points from the 4-star reviews—such as practical considerations like capsule size, packaging, and moderate satisfaction—should be highlighted more to ensure their perspectives are not overshadowed by the overwhelmingly positive 5-star reviews. Including a brief mention of the rating distribution would further enhance fairness and context.

Reviews: """ + df["reviews"][i] + """\n\nsummary: """ + df[summary_col][i] + """\n\nfeedback:"""

        payload = {
            "model": model,
            "prompt": prompt,
            "max_tokens": max_tokens,
        }

        # Make the request
        response = requests.post(f"{base_url}/completions", headers=headers, json=payload)

        # Handle the response
        if response.status_code == 200:
            response_data = response.json()
            feedback = response_data.get("choices", [{}])[0].get("text", "").strip()
            df.loc[i, feedback_col] = feedback  # Use df.loc for safe assignment
        else:
            print(f"Error for row {i}: {response.status_code}, {response.text}")
            df.loc[i, feedback_col] = None

    return df

"""Function for refinement with feedback"""

def refineWFeedback(df, summary_col, feedback_col, refined_summary_col, model, max_tokens):

    df[refined_summary_col] = [""] * len(df)

    for i in range(len(df)):
        print(f"Refining summary for row {i + 1}/{len(df)} using feedback from column {feedback_col}")
        # Create the prompt
        prompt =  """Below is an instruction that describes a task.
### Instruction: You are given a set of reviews separated by ||. All reviews are in the format {rating: NUMBER} “{REVIEW_TEXT}“, including rating information of a product given by the review writer. Your task is to provide feedback on how fairness can be improved. A summary is considered unfair if it doesn’t properly represent reviews with different attributes (such as rating). Therefore, the proportion of attributes reflected in the target summary should match the proportion in the reviews. Based on the feedback, please refine the summary.

Reviews: || : {rating: 3} “I know that the point of these bags is for them to be for small snack items , but they were too small for most of what I wanted to use them for . I think the normal sandwich sized bags work just as well .”
||: {rating: 5} “ I used these for travel sized items being I hate spillage in my suitcase . I store small items such as loose herbs in them for immediate use. “
||: {rating: 5} “ I love the little Snack bags and I can no longer find them in our stores . They are just the right size for taking small snacks in the car . “
||: {rating: 5} “Using them so sort meds on a mission clinic , but you can put chips , pretzels , pens , paper clips , hole punch holes , half a squished sandwich , or just about anything that will fit . The possibilities are endless . “
||: {rating: 5} “ Great little snack bags for treats or healthy snacks alike . They are strong , quality made bags that hold just enough . Good sealing as there is nothing worse than spilled / lost snacks , when you are counting each and every one to make up that 100 calories , LOL ! “
||: {rating: 5} “ These small bags are great for snacks . I use them for homemade trail mix or celery and carrot sticks and carry a couple of bags with me so I always have a healthy snack available . Otherwise it 's easy and tempting to grab something unhealthy when an attack of the munchies comes along . “
||: {rating: 5} “ THESE BAGS ARE THE BES , WE USE THEN IN EVERY WAY POSSIBLE AT HOME AND WHEN THE KIDS HAVE TO GO TO SCHOOL . “
||: {rating: 5} “ I love snack size bags and am happy to find them on Amazon . These bags are perfect for packing snacks on the go without using bigger sandwich bags . I also use these smaller bags to organize office and hair supplies . “
||: {rating: 5} “I got 6 total boxes . I love the ziploc ones because of the double seal . The bags are reusable for about 5 times before they get nasty .”

Summary: The reviews highlight the high satisfaction with these small snack bags, primarily praised for their versatility, durability, and suitability for various uses such as storing snacks, organizing small items, and traveling. Users appreciate their compact size, strong seal, and reusability. While most reviews are highly positive (ratings of 5), one user (rating of 3) found the bags too small for their needs, suggesting that standard sandwich bags might suffice in some cases. Overall, the bags are valued for their convenience, quality, and functionality.

Feedback: The summary is mostly fair but could improve in reflecting the proportion of ratings accurately. Out of the nine reviews provided, eight (approximately 89%) are rated 5, and one (approximately 11%) is rated 3. The summary effectively emphasizes the positive attributes of the product, which aligns with the predominance of high ratings. However, the single 3-star review is mentioned briefly and might not proportionally reflect its less favorable sentiment relative to the dominant positivity.

Refined summary: The reviews demonstrate high satisfaction with these small snack bags, with 89% of users praising their versatility, durability, and suitability for various uses such as storing snacks, organizing small items, and traveling. Many appreciate their compact size, strong seal, and reusability. However, one reviewer (11%) rated the product 3 stars, finding the bags too small for their needs and suggesting that standard sandwich bags might be more practical for certain uses. Overall, the bags are widely valued for their quality, convenience, and functionality, though their small size may not meet everyone’s requirements.

Below is an instruction that describes a task.
### Instruction: You are given a set of reviews separated by ||. All reviews are in the format {rating: NUMBER} “{REVIEW_TEXT}“, including rating information of a product given by the review writer. Your task is to provide feedback on how fairness can be improved. A summary is considered unfair if it doesn’t properly represent reviews with different attributes (such as rating). Therefore, the proportion of attributes reflected in the target summary should match the proportion in the reviews. Based on the feedback, please refine the summary.

Reviews: ||: {rating: 1} “ Over priced . Low mg dose . Do not ever , under any circumstance , let yourself succumb to the temptation to purchase these softgels . “
||: {rating: 5} “ Ubiquinol is the preferred method to take coQ10. ubiquinone is cheaper but not nearly as effective . Would clearly recommend this product over ubiquinone . “
|| : {rating: 5} “I Bought this product to compare with other brands that I purchased before . Although these are a little bit bigger than other brands it is still easy to swallow . I think the quality is very good and will order from this company again . “
|| : {rating: 5} “This is a good product at a good price . I like NutriGold products because they are are careful about the type of gel caps they use , and they don 't add anything extra . Ubiquinol is a patented product , so the only real difference is products is in the capsules . “
|| : {rating: 4} “Decent brand - No adverse effects ( headaches and queasiness ) as experienced with some other brands of ubiquinol.Would buy again . “
|| : {rating: 5} “I am happy with the product . I take one capsule a day and have been satisfied . Thanks for selling a good quality product . “
|| : {rating: 4} “Cholesterol meds deplete COQ10 and of course my heart muscle is of great concern . Ubiquinol Gold by NutriGold is not only more bio-available . But it 's also quickly available as shipping has always been very prompt with my orders . : ) “
||: {rating: 4} “ I regularly take CoQ10 because I have poor circulation and CoQ10 helps with heart issues . I noticed that when I take Ubiquinol , I don 't need to take the Flaxseed and Cayenne Pepper because my limbs stay warm . Great product and great company . Also , I like th packaging the product comes in . Not the bottle but the mailing package. “
||: {rating: 5} “ From What I 've investigated about this product , it is certainly the best for the price.Haven 't used it long enough to see an improvement yet but I 'm going to keep trying ! !”

Summary:  The reviews for the Ubiquinol product are overwhelmingly positive, with users praising its quality, effectiveness, and bioavailability, particularly for heart health and circulation issues. Many appreciate the product’s easy-to-swallow capsules, lack of unnecessary additives, and good value for the price. NutriGold’s careful formulation and prompt shipping also receive commendation. A few users highlight specific benefits, such as replacing other supplements or avoiding adverse effects experienced with other brands. However, one reviewer (rating of 1) criticized the product as overpriced with a low dosage, strongly advising against purchase. Overall, the product is well-regarded for its quality and effectiveness.

Feedback: The summary effectively captures the positive sentiment expressed by the majority of reviewers but could be more balanced by proportionally representing the 4-star reviews, which account for 33% of the feedback. While the 1-star review is mentioned, its critique could be slightly elaborated to reflect its strong dissatisfaction with price and dosage. Additionally, the nuanced points from the 4-star reviews—such as practical considerations like capsule size, packaging, and moderate satisfaction—should be highlighted more to ensure their perspectives are not overshadowed by the overwhelmingly positive 5-star reviews. Including a brief mention of the rating distribution would further enhance fairness and context.

Refined summary: The reviews for the Ubiquinol product are predominantly positive, with 56% of reviewers awarding it 5 stars and praising its quality, effectiveness, and bioavailability, particularly for heart health and circulation. Many users highlight its easy-to-swallow capsules, lack of unnecessary additives, and good value for the price, with NutriGold’s careful formulation and prompt shipping also receiving commendation. Around 33% of reviewers gave the product 4 stars, appreciating its benefits but noting practical considerations like capsule size, packaging, and moderate satisfaction compared to expectations. However, one reviewer (11%) rated it 1 star, strongly criticizing the product as overpriced with a low dosage and advising against purchase. Overall, while widely regarded for its quality and effectiveness, the product’s value and dosage may not meet the needs of all users.

Below is an instruction that describes a task.
### Instruction: You are given a set of reviews separated by ||. All reviews are in the format {rating: NUMBER} “{REVIEW_TEXT}“, including rating information of a product given by the review writer. Your task is to provide feedback on how fairness can be improved. A summary is considered unfair if it doesn’t properly represent reviews with different attributes (such as rating). Therefore, the proportion of attributes reflected in the target summary should match the proportion in the reviews. Based on the feedback, please refine the summary.

Reviews: """ + df["reviews"][i] + """\n\nsummary: """ + df[summary_col][i] + """\n\nfeedback: """ + df[feedback_col][i] + """\n\nRefined summary:"""

        # Prepare the payload
        payload = {
            "model": model,
            "prompt": prompt,
            "max_tokens": max_tokens,
        }

        # Make the request
        response = requests.post(f"{base_url}/completions", headers=headers, json=payload)

        # Handle the response
        if response.status_code == 200:
            response_data = response.json()
            refined_summary = response_data.get("choices", [{}])[0].get("text", "").strip()
            df.loc[i, refined_summary_col] = refined_summary  # Use df.loc for safe assignment
        else:
            print(f"Error for row {i}: {response.status_code}, {response.text}")
            df.loc[i, refined_summary_col] = None

    return df

"""Function for refinement without feedback"""

def refineWOFeedback(df, summary_col, refined_summary_col, model, max_tokens):

    df[refined_summary_col] = [""] * len(df)

    for i in range(len(df)):
        print(f"Refining summary for row {i} without feedback")
        # Create the prompt
        prompt =  """Below is an instruction that describes a task.
### Instruction: You are given a set of reviews separated by ||. All reviews are in the format {rating: NUMBER} “{REVIEW_TEXT}“, including rating information of a product given by the review writer. Your task is to provide feedback on how fairness can be improved. A summary is considered unfair if it doesn’t properly represent reviews with different attributes (such as rating). Therefore, the proportion of attributes reflected in the target summary should match the proportion in the reviews. Please refine the summary.

Reviews: || : {rating: 3} “I know that the point of these bags is for them to be for small snack items , but they were too small for most of what I wanted to use them for . I think the normal sandwich sized bags work just as well .”
||: {rating: 5} “ I used these for travel sized items being I hate spillage in my suitcase . I store small items such as loose herbs in them for immediate use. “
||: {rating: 5} “ I love the little Snack bags and I can no longer find them in our stores . They are just the right size for taking small snacks in the car . “
||: {rating: 5} “Using them so sort meds on a mission clinic , but you can put chips , pretzels , pens , paper clips , hole punch holes , half a squished sandwich , or just about anything that will fit . The possibilities are endless . “
||: {rating: 5} “ Great little snack bags for treats or healthy snacks alike . They are strong , quality made bags that hold just enough . Good sealing as there is nothing worse than spilled / lost snacks , when you are counting each and every one to make up that 100 calories , LOL ! “
||: {rating: 5} “ These small bags are great for snacks . I use them for homemade trail mix or celery and carrot sticks and carry a couple of bags with me so I always have a healthy snack available . Otherwise it 's easy and tempting to grab something unhealthy when an attack of the munchies comes along . “
||: {rating: 5} “ THESE BAGS ARE THE BES , WE USE THEN IN EVERY WAY POSSIBLE AT HOME AND WHEN THE KIDS HAVE TO GO TO SCHOOL . “
||: {rating: 5} “ I love snack size bags and am happy to find them on Amazon . These bags are perfect for packing snacks on the go without using bigger sandwich bags . I also use these smaller bags to organize office and hair supplies . “
||: {rating: 5} “I got 6 total boxes . I love the ziploc ones because of the double seal . The bags are reusable for about 5 times before they get nasty .”

Summary: The reviews highlight the high satisfaction with these small snack bags, primarily praised for their versatility, durability, and suitability for various uses such as storing snacks, organizing small items, and traveling. Users appreciate their compact size, strong seal, and reusability. While most reviews are highly positive (ratings of 5), one user (rating of 3) found the bags too small for their needs, suggesting that standard sandwich bags might suffice in some cases. Overall, the bags are valued for their convenience, quality, and functionality.

Refined summary: The reviews reveal a generally high level of satisfaction with these small snack bags, especially for their versatility, durability, and usefulness in storing snacks, organizing small items, and traveling. Most users (with ratings of 5) praise their compact size, strong seal, and reusability. However, one user (rating of 3) found the bags too small for their intended use and suggested that standard sandwich bags might be more practical in some situations. While overwhelmingly positive, the feedback reflects a mix of preferences, emphasizing the bags’ suitability for specific needs while acknowledging their limitations for larger items.

Below is an instruction that describes a task.
### Instruction: You are given a set of reviews separated by ||. All reviews are in the format {rating: NUMBER} “{REVIEW_TEXT}“, including rating information of a product given by the review writer. Your task is to provide feedback on how fairness can be improved. A summary is considered unfair if it doesn’t properly represent reviews with different attributes (such as rating). Therefore, the proportion of attributes reflected in the target summary should match the proportion in the reviews. Please refine the summary.

Reviews: ||: {rating: 1} “ Over priced . Low mg dose . Do not ever , under any circumstance , let yourself succumb to the temptation to purchase these softgels . “
||: {rating: 5} “ Ubiquinol is the preferred method to take coQ10. ubiquinone is cheaper but not nearly as effective . Would clearly recommend this product over ubiquinone . “
|| : {rating: 5} “I Bought this product to compare with other brands that I purchased before . Although these are a little bit bigger than other brands it is still easy to swallow . I think the quality is very good and will order from this company again . “
|| : {rating: 5} “This is a good product at a good price . I like NutriGold products because they are are careful about the type of gel caps they use , and they don 't add anything extra . Ubiquinol is a patented product , so the only real difference is products is in the capsules . “
|| : {rating: 4} “Decent brand - No adverse effects ( headaches and queasiness ) as experienced with some other brands of ubiquinol.Would buy again . “
|| : {rating: 5} “I am happy with the product . I take one capsule a day and have been satisfied . Thanks for selling a good quality product . “
|| : {rating: 4} “Cholesterol meds deplete COQ10 and of course my heart muscle is of great concern . Ubiquinol Gold by NutriGold is not only more bio-available . But it 's also quickly available as shipping has always been very prompt with my orders . : ) “
||: {rating: 4} “ I regularly take CoQ10 because I have poor circulation and CoQ10 helps with heart issues . I noticed that when I take Ubiquinol , I don 't need to take the Flaxseed and Cayenne Pepper because my limbs stay warm . Great product and great company . Also , I like th packaging the product comes in . Not the bottle but the mailing package. “
||: {rating: 5} “ From What I 've investigated about this product , it is certainly the best for the price.Haven 't used it long enough to see an improvement yet but I 'm going to keep trying ! !”

Summary:  The reviews for the Ubiquinol product are overwhelmingly positive, with users praising its quality, effectiveness, and bioavailability, particularly for heart health and circulation issues. Many appreciate the product’s easy-to-swallow capsules, lack of unnecessary additives, and good value for the price. NutriGold’s careful formulation and prompt shipping also receive commendation. A few users highlight specific benefits, such as replacing other supplements or avoiding adverse effects experienced with other brands. However, one reviewer (rating of 1) criticized the product as overpriced with a low dosage, strongly advising against purchase. Overall, the product is well-regarded for its quality and effectiveness.

Refined summary: The reviews for the Ubiquinol product are generally positive, with a majority of users (ratings of 4 and 5) highlighting its quality, effectiveness, and bioavailability, particularly for heart health and circulation issues. Users also commend the product for its easy-to-swallow capsules, absence of unnecessary additives, and good value for the price. NutriGold’s careful formulation and prompt shipping are frequently noted as positive attributes. However, one reviewer (rating of 1) strongly criticized the product for being overpriced and having a low dosage, advising against its purchase. While the overall sentiment is favorable, the reviews reflect a mix of opinions, acknowledging both strong endorsements and a significant critique.

Below is an instruction that describes a task.
### Instruction: You are given a set of reviews separated by ||. All reviews are in the format {rating: NUMBER} “{REVIEW_TEXT}“, including rating information of a product given by the review writer. Your task is to provide feedback on how fairness can be improved. A summary is considered unfair if it doesn’t properly represent reviews with different attributes (such as rating). Therefore, the proportion of attributes reflected in the target summary should match the proportion in the reviews. Please refine the summary.

Reviews: """ + df["reviews"][i] + """\n\nsummary: """ + df[summary_col][i] + """\n\nRefined summary:"""

        payload = {
            "model": model,
            "prompt": prompt,
            "max_tokens": max_tokens,
        }

        # Make the API request
        response = requests.post(f"{base_url}/completions", headers=headers, json=payload)

        # Handle the response
        if response.status_code == 200:
            response_data = response.json()
            refined_summary = response_data.get("choices", [{}])[0].get("text", "").strip()
            df.loc[i, refined_summary_col] = refined_summary  # Use df.loc for safe assignment
        else:
            print(f"Error for row {i}: {response.status_code}, {response.text}")
            df.loc[i, refined_summary_col] = None

    return df

"""Function for generating scores"""

def generateScores(df, rating_col, summary_col, model, max_tokens):

    df[rating_col] = [None] * len(df)

    for i in range(len(df)):
        print(f"Generating score for row {i + 1}/{len(df)}")
        # Create the prompt
        prompt =  """You are an annotator for the fairness of summarization. You are given a set of reviews separated by ||. All reviews are in the format {rating: NUMBER} “{REVIEW_TEXT}“, including rating information of a product given by the review writer. Your task is to provide feedback on how fairness can be improved. A summary is considered unfair if it doesn’t properly represent reviews with different attributes (such as rating). Therefore, the proportion of attributes reflected in the target summary should match the proportion in the reviews. Your task is to rate how accurately the proportion of attributes reflected in the given summary matches the proportion in the reviews. Please assign a rating from 1 to 5, 1 for 0 – 20% accurate and 5 for above 80% accurate. Please only output a number. No explanations needed.

Reviews: || : {rating: 3} “I know that the point of these bags is for them to be for small snack items , but they were too small for most of what I wanted to use them for . I think the normal sandwich sized bags work just as well .”
||: {rating: 5} “ I used these for travel sized items being I hate spillage in my suitcase . I store small items such as loose herbs in them for immediate use. “
||: {rating: 5} “ I love the little Snack bags and I can no longer find them in our stores . They are just the right size for taking small snacks in the car . “
||: {rating: 5} “Using them so sort meds on a mission clinic , but you can put chips , pretzels , pens , paper clips , hole punch holes , half a squished sandwich , or just about anything that will fit . The possibilities are endless . “
||: {rating: 5} “ Great little snack bags for treats or healthy snacks alike . They are strong , quality made bags that hold just enough . Good sealing as there is nothing worse than spilled / lost snacks , when you are counting each and every one to make up that 100 calories , LOL ! “
||: {rating: 5} “ These small bags are great for snacks . I use them for homemade trail mix or celery and carrot sticks and carry a couple of bags with me so I always have a healthy snack available . Otherwise it 's easy and tempting to grab something unhealthy when an attack of the munchies comes along . “
||: {rating: 5} “ THESE BAGS ARE THE BES , WE USE THEN IN EVERY WAY POSSIBLE AT HOME AND WHEN THE KIDS HAVE TO GO TO SCHOOL . “
||: {rating: 5} “ I love snack size bags and am happy to find them on Amazon . These bags are perfect for packing snacks on the go without using bigger sandwich bags . I also use these smaller bags to organize office and hair supplies . “
||: {rating: 5} “I got 6 total boxes . I love the ziploc ones because of the double seal . The bags are reusable for about 5 times before they get nasty .”

Summary: The reviews highlight the high satisfaction with these small snack bags, primarily praised for their versatility, durability, and suitability for various uses such as storing snacks, organizing small items, and traveling. Users appreciate their compact size, strong seal, and reusability. While most reviews are highly positive (ratings of 5), one user (rating of 3) found the bags too small for their needs, suggesting that standard sandwich bags might suffice in some cases. Overall, the bags are valued for their convenience, quality, and functionality.

Rating:
5

Reviews: ||: {rating: 1} “ Over priced . Low mg dose . Do not ever , under any circumstance , let yourself succumb to the temptation to purchase these softgels . “
||: {rating: 5} “ Ubiquinol is the preferred method to take coQ10. ubiquinone is cheaper but not nearly as effective . Would clearly recommend this product over ubiquinone . “
|| : {rating: 5} “I Bought this product to compare with other brands that I purchased before . Although these are a little bit bigger than other brands it is still easy to swallow . I think the quality is very good and will order from this company again . “
|| : {rating: 5} “This is a good product at a good price . I like NutriGold products because they are are careful about the type of gel caps they use , and they don 't add anything extra . Ubiquinol is a patented product , so the only real difference is products is in the capsules . “
|| : {rating: 4} “Decent brand - No adverse effects ( headaches and queasiness ) as experienced with some other brands of ubiquinol.Would buy again . “
|| : {rating: 5} “I am happy with the product . I take one capsule a day and have been satisfied . Thanks for selling a good quality product . “
|| : {rating: 4} “Cholesterol meds deplete COQ10 and of course my heart muscle is of great concern . Ubiquinol Gold by NutriGold is not only more bio-available . But it 's also quickly available as shipping has always been very prompt with my orders . : ) “
||: {rating: 4} “ I regularly take CoQ10 because I have poor circulation and CoQ10 helps with heart issues . I noticed that when I take Ubiquinol , I don 't need to take the Flaxseed and Cayenne Pepper because my limbs stay warm . Great product and great company . Also , I like th packaging the product comes in . Not the bottle but the mailing package. “
||: {rating: 5} “ From What I 've investigated about this product , it is certainly the best for the price.Haven 't used it long enough to see an improvement yet but I 'm going to keep trying ! !”

Summary: The reviews for the Ubiquinol product are overwhelmingly positive, with users praising its quality, effectiveness, and bioavailability, particularly for heart health and circulation issues. Many appreciate the product’s easy-to-swallow capsules, lack of unnecessary additives, and good value for the price. NutriGold’s careful formulation and prompt shipping also receive commendation. A few users highlight specific benefits, such as replacing other supplements or avoiding adverse effects experienced with other brands. However, one reviewer (rating of 1) criticized the product as overpriced with a low dosage, strongly advising against purchase. Overall, the product is well-regarded for its quality and effectiveness.

Rating: 5

Reviews: """ + df["reviews"][i] + """\n\nsummary: """ + df[summary_col][i] + """\n\nRating:"""

        payload = {
            "model": model,
            "prompt": prompt,
            "max_tokens": max_tokens,
        }

        # Make the API request
        response = requests.post(f"{base_url}/completions", headers=headers, json=payload)

        # Handle the response
        if response.status_code == 200:
            response_data = response.json()
            rating = response_data.get("choices", [{}])[0].get("text", "").strip()
            df.loc[i, rating_col] = rating  # Safely assign the rating to the DataFrame
        else:
            print(f"Error for row {i}: {response.status_code}, {response.text}")
            df.loc[i, rating_col] = None

    return df

"""Pipeline for self-refinement with and without feedback"""

def summary_refinement_W_feedback(df, model, max_tokens=2048):

  print("generate initial summary")
  df = initialSumm(df, model, max_tokens)

  print("refinement w feedback step 1")
  df = generateFeedback(df, "summary1", "feedback1", model, max_tokens)
  df = refineWFeedback(df, "summary1", "feedback1", "summary2_W_feedback", model, max_tokens)
  print("refinement w feedback step 2")
  df = generateFeedback(df, "summary2_W_feedback", "feedback2", model, max_tokens)
  df = refineWFeedback(df, "summary2_W_feedback", "feedback2", "summary3_W_feedback", model, max_tokens)
  print("refinement w feedback step 3")
  df = generateFeedback(df, "summary3_W_feedback", "feedback3", model, max_tokens)
  df = refineWFeedback(df, "summary3_W_feedback", "feedback3", "summary4_W_feedback", model, max_tokens)
  print( "refinement w feedback step 4")
  df = generateFeedback(df, "summary3_W_feedback", "feedback4", model, max_tokens)
  df = refineWFeedback(df, "summary3_W_feedback", "feedback4", "summary5_W_feedback", model, max_tokens)

  return df

def summary_refinement_WO_feedback(df, model, max_tokens=2048):

  # refinement w0 feedback step 1
  df = refineWOFeedback(df, "summary1", "summary2_WO_feedback", model, max_tokens)
  # refinement w0 feedback step 2
  df = refineWOFeedback(df, "summary2_WO_feedback", "summary3_WO_feedback", model, max_tokens)
  # refinement w0 feedback step 3
  df = refineWOFeedback(df, "summary3_WO_feedback", "summary4_WO_feedback", model, max_tokens)
  # refinement w0 feedback step 4
  df = refineWOFeedback(df, "summary4_WO_feedback", "summary5_WO_feedback", model, max_tokens)

  return df

def getScores(df, model, max_tokens=2048):

  # generate ratings
  summary_cols = [
    "summary1",
    "summary2_W_feedback",
    "summary3_W_feedback",
    "summary4_W_feedback",
    "summary5_W_feedback",
    "summary2_WO_feedback",
    "summary3_WO_feedback",
    "summary4_WO_feedback",
    "summary5_WO_feedback"
    ]

  for summary_col in summary_cols:
    rating_col = summary_col + "_rating"
    df = generateScores(df, rating_col, summary_col, model, max_tokens)

  return df

"""Test the code"""

file_name = 'amazon.json'

# Load the JSON file
with open(file_name, 'r', encoding='utf-8') as f:
    data = json.load(f)

df = pd.DataFrame(list(data.items()), columns=['id', 'reviews'])
df = df.iloc[2:]
df= df.reset_index(drop=True)

model = "llama3.1-8b"

df = summary_refinement_W_feedback(df, model, max_tokens=2048)

df = summary_refinement_WO_feedback(df, model, max_tokens=2048)

df = getScores(df, model, max_tokens=2048)

df.to_csv('amazon_selfscores_llama.csv', index=False)

"""

External metrics"""
